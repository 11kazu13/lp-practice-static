name: ğŸš€ Deploy website on push

on:
  push:
    branches:
      - main

jobs:
  web-deploy:
    name: ğŸ‰ Deploy
    runs-on: ubuntu-latest

    steps:
      - name: ğŸšš Get latest code
        uses: actions/checkout@v4

      - name: ğŸ” Allow IP (XREA SSH allow)
        env:
          XREA_API_SECRET_KEY: ${{ secrets.XREA_API_SECRET_KEY }}
        run: |
          set -eu

          GLOBAL_IP=$(curl -s https://api.ipify.org | tr -d '\n')
          echo "GLOBAL_IP=${GLOBAL_IP}"

          RES=$(curl -sS -X POST https://api.xrea.com/v1/tool/ssh_ip_allow \
            -d "account=i11kazu13" \
            -d "server_name=s325.xrea.com" \
            -d "api_secret_key=${XREA_API_SECRET_KEY}" \
            -d "param[addr]=${GLOBAL_IP}")

          echo "API_RES=${RES}"

          # XREAå´ã®åæ˜ å¾…ã¡ï¼ˆã¾ãšã¯é•·ã‚ï¼‰
          sleep 180

      - name: ğŸ“‚ Sync files (rsync over ssh)
        env:
          SSH_KEY: ${{ secrets.SSH_KEY }}
        run: |
          set -eu

          mkdir -p ~/.ssh
          printf "%s" "${SSH_KEY}" > ~/.ssh/id_ed25519
          chmod 400 ~/.ssh/id_ed25519

          # known_hostsãŒåŸå› ã§æ­¢ã‚ãªã„ï¼ˆæ•™æãƒ«ãƒ¼ãƒˆå„ªå…ˆã®ç°¡ç•¥åŒ–ï¼‰
          rsync -av -e "ssh -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=no" \
            ./ i11kazu13@s325.xrea.com:~/lp-practice-static
